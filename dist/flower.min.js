!function(e,t){"function"==typeof define&&define.amd?define(["exports"],function(i){t(e.Flower=i)}):t("object"==typeof exports?exports:e)}(this,function(e){"use strict";function t(){this._wasTriggered={},this._plannedToTrigger={},this._plannedToExecuteTriggers=!1,this._executingPlannedTriggers=!1,this._plannedSubscriptions={},this._plannedSubscribersWillExecute=!1,this._latestEventsDescriptors={},this._eventsDescriptors={},this._requestedBeforeProvided={},this._providers={},this._removingSubscribersRequested=!1,this.bindMethods(),Object.seal(this)}t.prototype.bindMethods=function(){this.on=this.on.bind(this),this.off=this.off.bind(this),this.trigger=this.trigger.bind(this),this.when=this.when.bind(this),this.provide=this.provide.bind(this)},t.prototype._registerEventHandlers=function(e,t,i,r){e[t]||(e[t]=[]),e[t].push({handler:i,subscriber:r})},t.prototype.on=function(e,t,i,r,s){"string"==typeof e&&(s=r,r=i,i=t,t=e,e=!1),"boolean"==typeof r&&(s=r,r=null);for(var n=t.split(/[ ,]+/),o=0;o<n.length;o+=1){if(t=n[o],s&&t in this._wasTriggered)try{i.call(r||this,this._wasTriggered[t])}catch(e){requestAnimationFrame(function(){throw e})}e?this._registerEventHandlers(this._latestEventsDescriptors,t,i,r):this._registerEventHandlers(this._eventsDescriptors,t,i,r)}return this},t.prototype._executePlannedTriggers=function(){this._executingPlannedTriggers=!0;for(var e in this._plannedToTrigger)this.trigger(e,this._plannedToTrigger[e]),delete this._plannedToTrigger[e];this._executingPlannedTriggers=!1},t.prototype._executePlannedSubscribers=function(){for(var e in this._plannedSubscriptions)e in this._plannedToTrigger||(this._triggerEvent(this._latestEventsDescriptors,e,this._wasTriggered[e]),delete this._plannedSubscriptions[e])},t.prototype.trigger=function(e,t,i){"string"==typeof e&&(i=t,t=e,e=!1),i=null!=i?i:null,e?(this._plannedToTrigger[t]=i,this._plannedToExecuteTriggers||(this._plannedToExecuteTriggers=!0,requestAnimationFrame(function(){this._executePlannedTriggers(),this._plannedToExecuteTriggers=!1}.bind(this)))):(this._triggerEvent(this._eventsDescriptors,t,i),t in this._latestEventsDescriptors&&(this._executingPlannedTriggers?this._triggerEvent(this._latestEventsDescriptors,t,i):(this._plannedSubscriptions[t]=null,this._plannedSubscribersWillExecute||(this._plannedSubscribersWillExecute=!0,requestAnimationFrame(function(){this._executePlannedSubscribers(),this._plannedSubscribersWillExecute=!1}.bind(this))))))},t.prototype._triggerEvent=function(e,t,i){this._wasTriggered[t]=null!=i?i:null;for(var r=e[t]||[],s=0;s<r.length;s+=1)if(!r[s].disabled)try{r[s].handler.call(r[s].subscriber||this,this._wasTriggered[t])}catch(e){requestAnimationFrame(function(){throw e})}},t.prototype.when=function(e,t){return t=!!t,new Promise(function(i){var r=this;t&&e in this._wasTriggered?i(this._wasTriggered[e]):this.on(e,function t(s){i(s),r.off(e,t)})}.bind(this))},t.prototype._markUnsubscribedHandlers=function(e,t,i,r){var s,n;if(t&&e[t]){if(!i&&!r)return;n=e[t];for(var o=0;o<n.length;o+=1)s=n[o],!s.disabled&&(i&&s.handler===i||r&&s.subscriber===r)&&(s.disabled=!0)}else for(var h in e)if(e[h]){n=e[h];for(var d=0;d<n.length;d+=1)s=n[d],!s.disabled&&(i&&s.handler===i||r&&s.subscriber===r)&&(s.disabled=!0)}},t.prototype.off=function(e,t,i,r){"string"==typeof e&&(r=i,i=t,t=e,e=!1),i&&"function"!=typeof i&&(r=i,i=null),e?this._markUnsubscribedHandlers(this._latestEventsDescriptors,t,i,r):this._markUnsubscribedHandlers(this._eventsDescriptors,t,i,r),this._removingSubscribersRequested||(this._removingSubscribersRequested=!0,requestAnimationFrame(function(){this._removeHandlers(),this._removingSubscribersRequested=!1}.bind(this)))},t.prototype._isEnabled=function(e){return!e.disabled},t.prototype._removeHandlers=function(e){for(var t in e){var i=e[t];e[t]=i.filter(this._isEnabled),e[t].length||delete e[t]}},t.prototype.request=function(e,t,i){return"function"==typeof t&&(i=t,t=i),this._providers[e]?new Promise(function(r){var s=this._providers[e](t);if(i){if(s&&"function"==typeof s.then)return s.then(i),s;i(s)}r(s)}.bind(this)):(this._requestedBeforeProvided[e]||(this._requestedBeforeProvided[e]=[]),new Promise(function(r,s){this._requestedBeforeProvided[e].push({resolver:function(e){i&&(e&&"function"==typeof e.then?e.then(i):(i(e),r(e))),e&&"function"==typeof e.then?e.then(r):r(e)},rejecter:s,args:t})}.bind(this)))},t.prototype.provide=function(e,t){if(this._providers[e])throw new Error('"'+e+'" is already provided');this._providers[e]=t;var i=this._requestedBeforeProvided[e];if(i)for(var r,s=0;s<i.length;s+=1){r=i[s];try{r.resolver(t(r.args))}catch(e){r.rejecter(e)}}},t.prototype.stopProviding=function(e){delete this._providers[e]},e.Flower=t});
